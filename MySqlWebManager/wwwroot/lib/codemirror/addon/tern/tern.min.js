!function(t){"object"==typeof exports&&"object"==typeof module?t(require("../../lib/codemirror")):"function"==typeof define&&define.amd?define(["../../lib/codemirror"],t):t(CodeMirror)}(function(g){"use strict";g.TernServer=function(t){var s=this,t=(this.options=t||{},this.options.plugins||(this.options.plugins={}));t.doc_comment||(t.doc_comment=!0),this.docs=Object.create(null),this.options.useWorker?this.server=new i(this):this.server=new tern.Server({getFile:function(t,e){return a(s,t,e)},async:!0,defs:this.options.defs||[],plugins:t}),this.trackChange=function(t,e){var n=s,o=u(n,t),i=n.cachedArgHints,r=(i&&i.doc==t&&0<=y(i.start,e.to)&&(n.cachedArgHints=null),null==(i=o.changed)&&(o.changed=i={from:e.from.line,to:e.from.line}),e.from.line+(e.text.length-1));e.from.line<i.to&&(i.to=i.to-(e.to.line-r)),r>=i.to&&(i.to=r+1),i.from>e.from.line&&(i.from=e.from.line),t.lineCount()>l&&100<e.to-i.from&&setTimeout(function(){o.changed&&100<o.changed.to-o.changed.from&&c(n,o)},200)},this.cachedArgHints=null,this.activeArgHints=null,this.jumpStack=[],this.getHint=function(t,e){var l,u,f;u=t,f=e,(l=s).request(u,{type:"completions",types:!0,docs:!0,urls:!0},function(t,e){if(t)return b(l,u,t);var n=[],o="",t=e.start,i=e.end;'["'==u.getRange(m(t.line,t.ch-2),t)&&'"]'!=u.getRange(i,m(i.line,i.ch+2))&&(o='"]');for(var r=0;r<e.completions.length;++r){var s=e.completions[r],a=function(t){t="?"==t?"unknown":"number"==t||"string"==t||"bool"==t?t:/^fn\(/.test(t)?"fn":/^\[/.test(t)?"array":"object";return d+"completion "+d+"completion-"+t}(s.type);e.guess&&(a+=" "+d+"guess"),n.push({text:s.name+o,displayText:s.displayName||s.name,className:a,data:s})}var t={from:t,to:i,list:n},c=null;g.on(t,"close",function(){w(c)}),g.on(t,"update",function(){w(c)}),g.on(t,"select",function(t,e){w(c);t=l.options.completionTip?l.options.completionTip(t.data):t.data.doc;t&&(c=x(e.parentNode.getBoundingClientRect().right+window.pageXOffset,e.getBoundingClientRect().top+window.pageYOffset,t,u,d+"hint-doc"))}),f(t)})},this.getHint.async=!0},g.TernServer.prototype={addDoc:function(t,e){var n={doc:e,name:t,changed:null};return this.server.addFile(t,k(this,n)),g.on(e,"change",this.trackChange),this.docs[t]=n},delDoc:function(t){t=e(this,t);t&&(g.off(t.doc,"change",this.trackChange),delete this.docs[t.name],this.server.delFile(t.name))},hideDoc:function(t){T(this);t=e(this,t);t&&t.changed&&c(this,t)},complete:function(t){t.showHint({hint:this.getHint})},showType:function(t,e,n){o(this,t,e,"type",n)},showDocs:function(t,e,n){o(this,t,e,"documentation",n)},updateArgHints:function(t){var n=this,o=t;if(T(n),!o.somethingSelected()){t=o.getTokenAt(o.getCursor()).state,t=g.innerMode(o.getMode(),t);if("javascript"==t.mode.name){var e=t.state.lexical;if("call"==e.info){for(var i,r,s=e.pos||0,a=o.getOption("tabSize"),c=o.getCursor().line,l=Math.max(0,c-9),u=!1;l<=c;--c){for(var f=o.getLine(c),d=0,p=0;;){var h=f.indexOf("\t",p);if(-1==h)break;d+=a-(h+d)%a-1,p=h+1}if(i=e.column-d,"("==f.charAt(i)){u=!0;break}}if(u)r=m(c,i),(t=n.cachedArgHints)&&t.doc==o.getDoc()&&0==y(r,t.start)?v(n,o,s):n.request(o,{type:"type",preferFunction:!0,end:r},function(t,e){!t&&e.type&&/^fn\(/.test(e.type)&&(n.cachedArgHints={start:r,type:function(i){var t=[],r=3;if(")"!=i.charAt(r))for(;;){var e=i.slice(r).match(/^([^, \(\[\{]+): /);if(e&&(r+=e[0].length,e=e[1]),t.push({name:e,type:function(t){for(var e=0,n=r;;){var o=i.charAt(r);if(t.test(o)&&!e)return i.slice(n,r);/[{\[\(]/.test(o)?++e:/[}\]\)]/.test(o)&&--e,++r}}(/[\),]/)}),")"==i.charAt(r))break;r+=2}var n=i.slice(r).match(/^\) -> (.*)$/);return{args:t,rettype:n&&n[1]}}(e.type),name:e.exprName||e.name||"fn",guess:e.guess,doc:o.getDoc()},v(n,o,s))})}}}},jumpToDef:function(t){function e(t){var t={type:"definition",variable:t||null},n=u(o,i.getDoc());o.server.request(f(o,n,t),function(t,e){if(t)return b(o,i,t);if(!e.file&&e.url)window.open(e.url);else{if(e.file){t=o.docs[e.file];if(t&&(e=function(t,e){for(var n=e.context.slice(0,e.contextOffset).split("\n"),o=e.start.line-(n.length-1),i=m(o,(1==n.length?e.start.ch:t.getLine(o).length)-n[0].length),r=t.getLine(o).slice(i.ch),s=1+o;s<t.lineCount()&&r.length<e.context.length;++s)r+="\n"+t.getLine(s);if(r.slice(0,e.context.length)==e.context)return e;var a,c=t.getSearchCursor(e.context,0,!1),l=1/0;for(;c.findNext();){var u=c.from(),f=1e4*Math.abs(u.line-i.line);(f=f||Math.abs(u.ch-i.ch))<l&&(a=u,l=f)}if(!a)return null;1==n.length?a.ch+=n[0].length:a=m(a.line+(n.length-1),n[n.length-1].length);o=e.start.line==e.end.line?m(a.line,a.ch+(e.end.ch-e.start.ch)):m(a.line+(e.end.line-e.start.line),e.end.ch);return{start:a,end:o}}(t.doc,e)))return o.jumpStack.push({file:n.name,start:i.getCursor("from"),end:i.getCursor("to")}),void r(o,n,t,e.start,e.end)}b(o,i,"Could not find a definition.")}})}var o,i;o=this,!function(t){var e=t.getCursor("end"),n=t.getTokenAt(e);return!(n.start<e.ch&&"comment"==n.type)&&/[\w)\]]/.test(t.getLine(e.line).slice(Math.max(e.ch-1,0),e.ch+1))}(i=t)?n(i,"Jump to variable",function(t){t&&e(t)}):e()},jumpBack:function(t){var e,n,o;t=t,n=(e=this).jumpStack.pop(),(o=n&&e.docs[n.file])&&r(e,u(e,t.getDoc()),o,n.start,n.end)},rename:function(t){var f=this,d=t,t=d.getTokenAt(d.getCursor());/\w/.test(t.string)?n(d,"New name for "+t.string,function(t){f.request(d,{type:"rename",newName:t,fullDocs:!0},function(t,e){if(t)return b(f,d,t);for(var n,o=f,i=e.changes,r=Object.create(null),s=0;s<i.length;++s){var a=i[s];(r[a.file]||(r[a.file]=[])).push(a)}for(n in r){var c=o.docs[n],l=r[n];if(c){l.sort(function(t,e){return y(e.start,t.start)});for(var u="*rename"+ ++p,s=0;s<l.length;++s){a=l[s];c.doc.replaceRange(a.text,a.start,a.end,u)}}}})}):b(f,d,"Not at a variable")},selectName:function(t){var a,c,l;l=u(a=this,(c=t).doc).name,a.request(c,{type:"refs"},function(t,e){if(t)return b(a,c,t);for(var n=[],o=0,i=c.getCursor(),r=0;r<e.refs.length;r++){var s=e.refs[r];s.file==l&&(n.push({anchor:s.start,head:s.end}),0<=y(i,s.start)&&y(i,s.end)<=0&&(o=n.length-1))}c.setSelections(n,o)})},request:function(t,n,o,e){var i=this,r=u(this,t.getDoc()),s=f(this,r,n,e),a=s.query&&this.options.queryOptions&&this.options.queryOptions[s.query.type];if(a)for(var c in a)s.query[c]=a[c];this.server.request(s,function(t,e){!t&&i.options.responseFilter&&(e=i.options.responseFilter(r,n,s,t,e)),o(t,e)})},destroy:function(){T(this),this.worker&&(this.worker.terminate(),this.worker=null)}};var m=g.Pos,d="CodeMirror-Tern-",l=250;function a(t,e,n){var o=t.docs[e];o?n(k(t,o)):t.options.getFile?t.options.getFile(e,n):n(null)}function u(t,e,n){for(var o in t.docs){var i=t.docs[o];if(i.doc==e)return i}if(!n)for(var r=0;;++r)if(!t.docs[o="[doc"+(r||"")+"]"]){n=o;break}return t.addDoc(n,e)}function e(t,e){return"string"==typeof e?t.docs[e]:(e=e instanceof g?e.getDoc():e)instanceof g.Doc?u(t,e):void 0}function c(t,e){t.server.request({files:[{type:"full",name:e.name,text:k(t,e)}]},function(t){t?window.console.error(t):e.changed=null})}function o(o,i,t,e,r){o.request(i,e,function(t,e){if(t)return b(o,i,t);var n;o.options.typeTip?n=o.options.typeTip(e):(n=h("span",null,h("strong",null,e.type||"not found")),e.doc&&n.appendChild(document.createTextNode(" — "+e.doc)),e.url&&(n.appendChild(document.createTextNode(" ")),(t=n.appendChild(h("a",null,"[docs]"))).href=e.url,t.target="_blank")),s(i,n,o),r&&r()},t)}function v(t,e,n){T(t);for(var o=t.cachedArgHints,i=o.type,r=h("span",o.guess?d+"fhint-guess":null,h("span",d+"fname",o.name),"("),s=0;s<i.args.length;++s){s&&r.appendChild(document.createTextNode(", "));var a=i.args[s];r.appendChild(h("span",d+"farg"+(s==n?" "+d+"farg-current":""),a.name||"?")),"?"!=a.type&&(r.appendChild(document.createTextNode(": ")),r.appendChild(h("span",d+"type",a.type)))}r.appendChild(document.createTextNode(i.rettype?") -> ":")")),i.rettype&&r.appendChild(h("span",d+"type",i.rettype));var o=e.cursorCoords(null,"page"),c=t.activeArgHints=x(o.right+1,o.bottom,r,e);setTimeout(function(){c.clear=C(e,function(){t.activeArgHints==c&&T(t)})},20)}function r(t,e,n,o,i){n.doc.setSelection(o,i),e!=n&&t.options.switchToDoc&&(T(t),t.options.switchToDoc(n.name,n.doc))}var p=0;function f(t,e,n,o){var i,r=[],s=0,a=!n.fullDocs,o=(a||delete n.fullDocs,(n="string"==typeof n?{type:n}:n).lineCharPositions=!0,null==n.end&&(n.end=o||e.doc.getCursor("end"),e.doc.somethingSelected()&&(n.start=e.doc.getCursor("start"))),n.start||n.end);for(i in e.changed?e.doc.lineCount()>l&&!1!=a&&e.changed.to-e.changed.from<100&&e.changed.from<=o.line&&e.changed.to>n.end.line?(r.push(function(t,e,n){for(var o,i=t.doc,r=null,s=null,a=e.line-1,c=Math.max(0,a-50);c<=a;--a){var l=i.getLine(a);l.search(/\bfunction\b/)<0||(f=g.countColumn(l,null,4),null!=r&&r<=f||(r=f,s=a))}null==s&&(s=c);var u=Math.min(i.lastLine(),n.line+20);if(null==r||r==g.countColumn(i.getLine(e.line),null,4))o=u;else for(o=n.line+1;o<u;++o){var f;if((f=g.countColumn(i.getLine(o),null,4))<=r)break}e=m(s,0);return{type:"part",name:t.name,offsetLines:e.line,text:i.getRange(e,m(o,n.line==o?null:0))}}(e,o,n.end)),n.file="#0",s=r[0].offsetLines,null!=n.start&&(n.start=m(n.start.line- -s,n.start.ch)),n.end=m(n.end.line-s,n.end.ch)):(r.push({type:"full",name:e.name,text:k(t,e)}),n.file=e.name,e.changed=null):n.file=e.name,t.docs){var c=t.docs[i];c.changed&&c!=e&&(r.push({type:"full",name:c.name,text:k(t,c)}),c.changed=null)}return{query:n,files:r}}var y=g.cmpPos;function h(t,e){var n=document.createElement(t);e&&(n.className=e);for(var o=2;o<arguments.length;++o){var i=arguments[o];"string"==typeof i&&(i=document.createTextNode(i)),n.appendChild(i)}return n}function n(t,e,n){t.openDialog?t.openDialog(e+": <input type=text>",n):n(prompt(e,""))}function s(e,t,n){e.state.ternTooltip&&w(e.state.ternTooltip);var o=e.cursorCoords(),i=e.state.ternTooltip=x(o.right+1,o.bottom,t,e);function r(){var t;e.state.ternTooltip=null,i.parentNode&&((t=i).style.opacity="0",setTimeout(function(){w(t)},1100)),c()}var s=!1,a=!1,c=(g.on(i,"mousemove",function(){s=!0}),g.on(i,"mouseout",function(t){t=t.relatedTarget||t.toElement;t&&g.contains(i,t)||(a?r():s=!1)}),setTimeout(function(){a=!0,s||r()},n.options.hintDelay||1700),C(e,r))}function C(t,e){return t.on("cursorActivity",e),t.on("blur",e),t.on("scroll",e),t.on("setDoc",e),function(){t.off("cursorActivity",e),t.off("blur",e),t.off("scroll",e),t.off("setDoc",e)}}function x(t,e,n,o,i){i=h("div",d+"tooltip "+(i||""),n);i.style.left=t+"px",i.style.top=e+"px";(((o.options||{}).hintOptions||{}).container||document.body).appendChild(i);var n=o.cursorCoords(),e=window.innerWidth,o=window.innerHeight,r=i.getBoundingClientRect(),s=document.querySelector(".CodeMirror-hints"),a=r.bottom-o,c=r.right-e;return s&&0<c&&(i.style.left=0,r=i.getBoundingClientRect(),i.style.left=(t=t-s.offsetWidth-r.width)+"px",c=r.right-e),0<a&&(s=r.bottom-r.top,0<n.top-(n.bottom-r.top)-s?i.style.top=n.top-s+"px":o<s&&(i.style.height=o-5+"px",i.style.top=n.bottom-r.top+"px")),0<c&&(r.right-r.left>e&&(i.style.width=e-5+"px",c-=r.right-r.left-e),i.style.left=t-c+"px"),i}function w(t){var e=t&&t.parentNode;e&&e.removeChild(t)}function b(t,e,n){t.options.showError?t.options.showError(e,n):s(e,String(n),t)}function T(t){t.activeArgHints&&(t.activeArgHints.clear&&t.activeArgHints.clear(),w(t.activeArgHints),t.activeArgHints=null)}function k(t,e){var n=e.doc.getValue();return n=t.options.fileFilter?t.options.fileFilter(n,e.name,e.doc):n}function i(e){var n=e.worker=new Worker(e.options.workerScript),o=(n.postMessage({type:"init",defs:e.options.defs,plugins:e.options.plugins,scripts:e.options.workerDeps}),0),i={};function r(t,e){e&&(t.id=++o,i[o]=e),n.postMessage(t)}n.onmessage=function(t){var n=t.data;"getFile"==n.type?a(e,n.name,function(t,e){r({type:"getFile",err:String(t),text:e,id:n.id})}):"debug"==n.type?window.console.log(n.message):n.id&&i[n.id]&&(i[n.id](n.err,n.body),delete i[n.id])},n.onerror=function(t){for(var e in i)i[e](t);i={}},this.addFile=function(t,e){r({type:"add",name:t,text:e})},this.delFile=function(t){r({type:"del",name:t})},this.request=function(t,e){r({type:"req",body:t},e)}}});